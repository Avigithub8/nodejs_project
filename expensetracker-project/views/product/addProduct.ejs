<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Product</title>
  </head>
  <body>
    <h2>Welcome, <%= username %>!</h2>

    <form id="addProductForm" action="/product/addProduct" method="POST">
      <input type="hidden" name="userId" value="<%= userId %>" required />
      <label>Amount: <input type="text" name="amount" required /></label>
      <label
        >Description: <input type="text" name="description" required
      /></label>
      <label>Category: <input type="text" name="category" required /></label>

      <button type="submit">Add Product</button>
    </form>
    <br />

    <% if (isPremium) { %>
    <p>You are a premium user!</p>

    <h2>Your Products:</h2>
    <ul id="productList">
      <% for (const product of products) { %>
      <li>
        <%= product.amount %> - <%= product.description %> - <%=
        product.category %>
        <a
          href="/product/addProduct/<%= userId %>"
          onclick="deleteProduct('<%= product.id %>', '<%= userId %>')"
          >Delete</a
        >
      </li>
      <% } %>
    </ul>

    <button onclick="showLeaderboard()">Show Leaderboard</button>

    <% } else { %>
    <a href="/product/buyPremium?userId=<%= userId %>">Buy Premium</a>
    <h2>Your Products:</h2>
    <ul id="productList">
      <% for (const product of products) { %>
      <li>
        <%= product.amount %> - <%= product.description %> - <%=
        product.category %>
        <a
          href="/product/addProduct/<%= userId %>"
          onclick="deleteProduct('<%= product.id %>', '<%= userId %>')"
          >Delete</a
        >
      </li>
      <% } %>
    </ul>
    <% } %>

    <div id="leaderboardSection" style="display: none"></div>

    <script>
      async function deleteProduct(productId, userId) {
        try {
          const response = await fetch(
            `http://localhost:3000/product/deleteProduct/${productId}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const productList = document.getElementById("productList");

          const deletedProductElement = document.querySelector(
            `li:has(button[onclick="deleteProduct(${productId})"])`
          );
          deletedProductElement.remove();

          window.location.href = `/product/addProduct/${userId}`;
        } catch (error) {
          console.error("Error deleting product:", error);
        }
      }

      async function showLeaderboard() {
        try {
          const response = await fetch(
            "http://localhost:3000/product/leaderboard"
          );
          const data = await response.json();

          if (data.success) {
            const leaderboardSection =
              document.getElementById("leaderboardSection");
            leaderboardSection.innerHTML = generateLeaderboardHTML(
              data.leaderboard
            );
            leaderboardSection.style.display = "block";
          } else {
            console.error("Error fetching leaderboard data:", data.message);
          }
        } catch (error) {
          console.error("Error fetching leaderboard data:", error);
        }
      }

      function generateLeaderboardHTML(leaderboard) {
        if (!leaderboard || leaderboard.length === 0) {
          return "<p>No users in the leaderboard</p>";
        }

        const leaderboardHTML = leaderboard
          .map(
            (user, index) => `
      <li>
        <span class="rank">Index: ${index + 1} ,</span>
        <span class="username">Name: ${user.username} ,</span>
        <span class="amount">Amount: ${getUpdatedAmount(user)} </span>
        ${
          user.username === "random"
            ? `<button onclick="deleteUser('${user.id}')">Delete</button>`
            : ""
        }
       </li>
    `
          )
          .join("");

        return `<ul>${leaderboardHTML}</ul>`;
      }

      function getUpdatedAmount(user) {
        const totalAmount = user.Products.reduce(
          (sum, product) => sum + product.amount,
          0
        );

        return totalAmount;
      }

      async function deleteUser(userId) {
        try {
          const response = await fetch(
            `http://localhost:3000/user/deleteUser/${userId}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          await showLeaderboard();
        } catch (error) {
          console.error("Error deleting user:", error);
          alert("Error deleting user. Check console for details.");
        }
      }
    </script>
  </body>
</html>
